#!/usr/bin/env sh

echo "ğŸ” Running pre-commit checks..."

# Validate branch name
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
BRANCH_PATTERN="^(main|develop|(feature|fix|docs|refactor|test|chore|ci|perf|build|revert)/[0-9]+-[a-z0-9-]+)$"

if ! echo "$BRANCH_NAME" | grep -qE "$BRANCH_PATTERN"; then
  echo "âŒ Invalid branch name: $BRANCH_NAME"
  echo ""
  echo "Branch names must follow the pattern:"
  echo "  main, develop, or <type>/<issue-number>-<description>"
  echo ""
  echo "Types: feature, fix, docs, refactor, test, chore, ci, perf, build, revert"
  echo ""
  echo "Examples:"
  echo "  feature/001-user-authentication"
  echo "  fix/042-login-redirect-issue"
  echo "  docs/015-api-documentation"
  exit 1
fi
echo "âœ… Branch name valid: $BRANCH_NAME"

# Run lint-staged (lint + format + secret detection)
echo "ğŸ“ Linting staged files..."
pnpm exec lint-staged
if [ $? -ne 0 ]; then
  echo "âŒ Lint-staged failed. Please fix the errors above."
  exit 1
fi

# Run type checking
echo "ğŸ” Running type check..."
pnpm tsc --noEmit
if [ $? -ne 0 ]; then
  echo "âŒ Type check failed. Please fix the type errors above."
  exit 1
fi

# Run tests
echo "ğŸ§ª Running tests..."
pnpm test
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Please fix the failing tests above."
  exit 1
fi

echo "âœ… All pre-commit checks passed!"
